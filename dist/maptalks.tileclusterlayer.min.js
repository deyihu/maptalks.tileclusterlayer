/*!
 * maptalks.tileclusterlayer v0.0.6
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks)}(this,(function(t,e){"use strict";var r=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){var r=function(){var t={},e=Math.PI/180,r=180/Math.PI,i=6378137,n=20037508.342789244;function o(t){return Number(t)===t&&t%1!=0}function s(e){if(e=e||{},this.size=e.size||256,this.expansion=!0===e.antimeridian?2:1,!t[this.size]){var r=this.size,i=t[this.size]={};i.Bc=[],i.Cc=[],i.zc=[],i.Ac=[];for(var n=0;n<30;n++)i.Bc.push(r/360),i.Cc.push(r/(2*Math.PI)),i.zc.push(r/2),i.Ac.push(r),r*=2}this.Bc=t[this.size].Bc,this.Cc=t[this.size].Cc,this.zc=t[this.size].zc,this.Ac=t[this.size].Ac}return s.prototype.px=function(t,r){if(o(r)){var i=this.size*Math.pow(2,r),n=i/2,s=i/360,a=i/(2*Math.PI),h=i,u=Math.min(Math.max(Math.sin(e*t[1]),-.9999),.9999),l=n+t[0]*s,c=n+.5*Math.log((1+u)/(1-u))*-a;return l>h*this.expansion&&(l=h*this.expansion),c>h&&(c=h),[l,c]}n=this.zc[r],u=Math.min(Math.max(Math.sin(e*t[1]),-.9999),.9999),l=Math.round(n+t[0]*this.Bc[r]),c=Math.round(n+.5*Math.log((1+u)/(1-u))*-this.Cc[r]);return l>this.Ac[r]*this.expansion&&(l=this.Ac[r]*this.expansion),c>this.Ac[r]&&(c=this.Ac[r]),[l,c]},s.prototype.ll=function(t,e){if(o(e)){var i=this.size*Math.pow(2,e),n=i/360,s=i/(2*Math.PI),a=i/2,h=(t[1]-a)/-s;return[(t[0]-a)/n,r*(2*Math.atan(Math.exp(h))-.5*Math.PI)]}h=(t[1]-this.zc[e])/-this.Cc[e];return[(t[0]-this.zc[e])/this.Bc[e],r*(2*Math.atan(Math.exp(h))-.5*Math.PI)]},s.prototype.bbox=function(t,e,r,i,n){i&&(e=Math.pow(2,r)-1-e);var o=[t*this.size,(+e+1)*this.size],s=[(+t+1)*this.size,e*this.size],a=this.ll(o,r).concat(this.ll(s,r));return"900913"===n?this.convert(a,"900913"):a},s.prototype.xyz=function(t,e,r,i){"900913"===i&&(t=this.convert(t,"WGS84"));var n=[t[0],t[1]],o=[t[2],t[3]],s=this.px(n,e),a=this.px(o,e),h=[Math.floor(s[0]/this.size),Math.floor((a[0]-1)/this.size)],u=[Math.floor(a[1]/this.size),Math.floor((s[1]-1)/this.size)],l={minX:Math.min.apply(Math,h)<0?0:Math.min.apply(Math,h),minY:Math.min.apply(Math,u)<0?0:Math.min.apply(Math,u),maxX:Math.max.apply(Math,h),maxY:Math.max.apply(Math,u)};if(r){var c={minY:Math.pow(2,e)-1-l.maxY,maxY:Math.pow(2,e)-1-l.minY};l.minY=c.minY,l.maxY=c.maxY}return l},s.prototype.convert=function(t,e){return"900913"===e?this.forward(t.slice(0,2)).concat(this.forward(t.slice(2,4))):this.inverse(t.slice(0,2)).concat(this.inverse(t.slice(2,4)))},s.prototype.forward=function(t){var r=[i*t[0]*e,i*Math.log(Math.tan(.25*Math.PI+.5*t[1]*e))];return r[0]>n&&(r[0]=n),r[0]<-n&&(r[0]=-n),r[1]>n&&(r[1]=n),r[1]<-n&&(r[1]=-n),r},s.prototype.inverse=function(t){return[t[0]*r/i,(.5*Math.PI-2*Math.atan(Math.exp(-t[1]/i)))*r]},s}();t.exports=r}));function i(t,e,r,o,s,a){if(s-o<=r)return;const h=o+s>>1;n(t,e,h,o,s,a%2),i(t,e,r,o,h-1,a+1),i(t,e,r,h+1,s,a+1)}function n(t,e,r,i,s,a){for(;s>i;){if(s-i>600){const o=s-i+1,h=r-i+1,u=Math.log(o),l=.5*Math.exp(2*u/3),c=.5*Math.sqrt(u*l*(o-l)/o)*(h-o/2<0?-1:1);n(t,e,r,Math.max(i,Math.floor(r-h*l/o+c)),Math.min(s,Math.floor(r+(o-h)*l/o+c)),a)}const h=e[2*r+a];let u=i,l=s;for(o(t,e,i,r),e[2*s+a]>h&&o(t,e,i,s);u<l;){for(o(t,e,u,l),u++,l--;e[2*u+a]<h;)u++;for(;e[2*l+a]>h;)l--}e[2*i+a]===h?o(t,e,i,l):(l++,o(t,e,l,s)),l<=r&&(i=l+1),r<=l&&(s=l-1)}}function o(t,e,r,i){s(t,r,i),s(e,2*r,2*i),s(e,2*r+1,2*i+1)}function s(t,e,r){const i=t[e];t[e]=t[r],t[r]=i}function a(t,e,r,i){const n=t-r,o=e-i;return n*n+o*o}const h=t=>t[0],u=t=>t[1];class l{constructor(t,e=h,r=u,n=64,o=Float64Array){this.nodeSize=n,this.points=t;const s=t.length<65536?Uint16Array:Uint32Array,a=this.ids=new s(t.length),l=this.coords=new o(2*t.length);for(let i=0;i<t.length;i++)a[i]=i,l[2*i]=e(t[i]),l[2*i+1]=r(t[i]);i(a,l,n,0,a.length-1,0)}range(t,e,r,i){return function(t,e,r,i,n,o,s){const a=[0,t.length-1,0],h=[];let u,l;for(;a.length;){const c=a.pop(),p=a.pop(),f=a.pop();if(p-f<=s){for(let s=f;s<=p;s++)u=e[2*s],l=e[2*s+1],u>=r&&u<=n&&l>=i&&l<=o&&h.push(t[s]);continue}const m=Math.floor((f+p)/2);u=e[2*m],l=e[2*m+1],u>=r&&u<=n&&l>=i&&l<=o&&h.push(t[m]);const g=(c+1)%2;(0===c?r<=u:i<=l)&&(a.push(f),a.push(m-1),a.push(g)),(0===c?n>=u:o>=l)&&(a.push(m+1),a.push(p),a.push(g))}return h}(this.ids,this.coords,t,e,r,i,this.nodeSize)}within(t,e,r){return function(t,e,r,i,n,o){const s=[0,t.length-1,0],h=[],u=n*n;for(;s.length;){const l=s.pop(),c=s.pop(),p=s.pop();if(c-p<=o){for(let n=p;n<=c;n++)a(e[2*n],e[2*n+1],r,i)<=u&&h.push(t[n]);continue}const f=Math.floor((p+c)/2),m=e[2*f],g=e[2*f+1];a(m,g,r,i)<=u&&h.push(t[f]);const M=(l+1)%2;(0===l?r-n<=m:i-n<=g)&&(s.push(p),s.push(f-1),s.push(M)),(0===l?r+n>=m:i+n>=g)&&(s.push(f+1),s.push(c),s.push(M))}return h}(this.ids,this.coords,t,e,r,this.nodeSize)}}var c=Math.PI/180,p=180/Math.PI;function f(t){var e=m(t[0]+1,t[2]);return[m(t[0],t[2]),g(t[1]+1,t[2]),e,g(t[1],t[2])]}function m(t,e){return t/Math.pow(2,e)*360-180}function g(t,e){var r=Math.PI-2*Math.PI*t/Math.pow(2,e);return p*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function M(t,e,r){var i=b(t,e,r);return i[0]=Math.floor(i[0]),i[1]=Math.floor(i[1]),i}function y(t){return[[2*t[0],2*t[1],t[2]+1],[2*t[0]+1,2*t[1],t[2]+1],[2*t[0]+1,2*t[1]+1,t[2]+1],[2*t[0],2*t[1]+1,t[2]+1]]}function d(t){return[t[0]>>1,t[1]>>1,t[2]-1]}function x(t){return y(d(t))}function v(t,e){for(var r=0;r<t.length;r++)if(_(t[r],e))return!0;return!1}function _(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function b(t,e,r){var i=Math.sin(e*c),n=Math.pow(2,r),o=n*(t/360+.5);return(o%=n)<0&&(o+=n),[o,n*(.5-.25*Math.log((1+i)/(1-i))/Math.PI),r]}var k={tileToGeoJSON:function(t){var e=f(t);return{type:"Polygon",coordinates:[[[e[0],e[3]],[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]]}},tileToBBOX:f,getChildren:y,getParent:d,getSiblings:x,hasTile:v,hasSiblings:function(t,e){for(var r=x(t),i=0;i<r.length;i++)if(!v(e,r[i]))return!1;return!0},tilesEqual:_,tileToQuadkey:function(t){for(var e="",r=t[2];r>0;r--){var i=0,n=1<<r-1;0!=(t[0]&n)&&i++,0!=(t[1]&n)&&(i+=2),e+=i.toString()}return e},quadkeyToTile:function(t){for(var e=0,r=0,i=t.length,n=i;n>0;n--){var o=1<<n-1,s=+t[i-n];1===s&&(e|=o),2===s&&(r|=o),3===s&&(e|=o,r|=o)}return[e,r,i]},pointToTile:M,bboxToTile:function(t){var e=M(t[0],t[1],32),r=M(t[2],t[3],32),i=[e[0],e[1],r[0],r[1]],n=function(t){for(var e=28,r=0;r<e;r++){var i=1<<32-(r+1);if((t[0]&i)!=(t[2]&i)||(t[1]&i)!=(t[3]&i))return r}return e}(i);return 0===n?[0,0,0]:[i[0]>>>32-n,i[1]>>>32-n,n]},pointToTileFraction:b};function z(t){return{type:"Feature",geometry:k.tileToGeoJSON(t),properties:{}}}function C(t,e){var r,i,n=t.coordinates,o=e.max_zoom,s={},a=[];if("Point"===t.type)return[k.pointToTile(n[0],n[1],o)];if("MultiPoint"===t.type)for(r=0;r<n.length;r++)s[E((i=k.pointToTile(n[r][0],n[r][1],o))[0],i[1],i[2])]=!0;else if("LineString"===t.type)T(s,n,o);else if("MultiLineString"===t.type)for(r=0;r<n.length;r++)T(s,n[r],o);else if("Polygon"===t.type)P(s,a,n,o);else{if("MultiPolygon"!==t.type)throw new Error("Geometry type not implemented");for(r=0;r<n.length;r++)P(s,a,n[r],o)}if(e.min_zoom!==o){var h=a.length;for(S(s,a),r=0;r<h;r++){var u=a[r];s[E(u[0],u[1],u[2])]=!0}return function(t,e,r){for(var i=[],n=r.max_zoom;n>r.min_zoom;n--){for(var o={},s=[],a=0;a<e.length;a++){var h=e[a];if(h[0]%2==0&&h[1]%2==0){var u=E(h[0]+1,h[1],n),l=E(h[0],h[1]+1,n),c=E(h[0]+1,h[1]+1,n);if(t[u]&&t[l]&&t[c]){t[E(h[0],h[1],h[2])]=!1,t[u]=!1,t[l]=!1,t[c]=!1;var p=[h[0]/2,h[1]/2,n-1];n-1===r.min_zoom?i.push(p):(o[E(h[0]/2,h[1]/2,n-1)]=!0,s.push(p))}}}for(a=0;a<e.length;a++)t[E((h=e[a])[0],h[1],h[2])]&&i.push(h);t=o,e=s}return i}(s,a,e)}return S(s,a),a}function P(t,e,r,i){for(var n=[],o=0;o<r.length;o++){var s=[];T(t,r[o],i,s);for(var a=0,h=s.length,u=h-1;a<h;u=a++){var l=(a+1)%h,c=s[a][1];(c>s[u][1]||c>s[l][1])&&(c<s[u][1]||c<s[l][1])&&c!==s[l][1]&&n.push(s[a])}}for(n.sort(w),o=0;o<n.length;o+=2){c=n[o][1];for(var p=n[o][0]+1;p<n[o+1][0];p++){t[E(p,c,i)]||e.push([p,c,i])}}}function w(t,e){return t[1]-e[1]||t[0]-e[0]}function T(t,e,r,i){for(var n,o,s=0;s<e.length-1;s++){var a=k.pointToTileFraction(e[s][0],e[s][1],r),h=k.pointToTileFraction(e[s+1][0],e[s+1][1],r),u=a[0],l=a[1],c=h[0]-u,p=h[1]-l;if(0!==p||0!==c){var f=c>0?1:-1,m=p>0?1:-1,g=Math.floor(u),M=Math.floor(l),y=0===c?1/0:Math.abs(((c>0?1:0)+g-u)/c),d=0===p?1/0:Math.abs(((p>0?1:0)+M-l)/p),x=Math.abs(f/c),v=Math.abs(m/p);for(g===n&&M===o||(t[E(g,M,r)]=!0,i&&M!==o&&i.push([g,M]),n=g,o=M);y<1||d<1;)y<d?(y+=x,g+=f):(d+=v,M+=m),t[E(g,M,r)]=!0,i&&M!==o&&i.push([g,M]),n=g,o=M}}i&&M===i[0][1]&&i.pop()}function S(t,e){for(var r,i,n,o,s,a=Object.keys(t),h=0;h<a.length;h++)e.push((r=+a[h],i=void 0,n=void 0,o=void 0,s=void 0,void 0,[s=(o=(r-(i=r%32))/32)%(n=2*(1<<i)),(o-s)/n%n,i]))}function E(t,e,r){return 32*(2*(1<<r)*e+t)+r}var I={geojson:function(t,e){return{type:"FeatureCollection",features:C(t,e).map(z)}},tiles:C,indexes:function(t,e){return C(t,e).map(k.tileToQuadkey)}};const A=178,F=[];for(let t=0;t<31;t++)F.push(129202.08021/Math.pow(2,t));class G extends e.VectorLayer{constructor(t,e){super(t,e),this._tileCache={},this._currentTileCache={},this.merc=new r({size:256}),this.globalPoints=[],this.globalFeatures=[],this.kdbush=null}_isGeoJSON(t){return t&&t.features&&Array.isArray(t.features)}_isEmpty(){return 0===this.globalPoints.length}_init(){return this.clear(),this._tileCache={},this._currentTileCache={},this._viewChange(),this}setData(t){if(!this._isGeoJSON(t))return console.error("data is not geojson"),this;const{features:e,points:r}=this._filterGeoJSON(t);return this.globalFeatures=e,this.globalPoints=r,this.kdbush=new l(r),this._init(),this}onAdd(){super.onAdd();const t=this.map||this.getMap();return t?(t.on("viewchange",this._viewChange,this),t.on("spatialreferencechange",this._init,this),this._viewChange(),this):this}onRemove(){super.onRemove();const t=this.map||this.getMap();return t?(t.off("viewchange",this._viewChange,this),t.off("spatialreferencechange",this._init,this),this):this}_viewChange(){if(this._isEmpty())return this;const t=this.getMap();if(!t)return this;const e=this.getGeometries().filter((t=>t._isDispersion));e&&this.removeGeometry(e);const r=t.getExtent();r.xmin>r.xmax&&(r.xmax=A),r.ymin>r.ymax&&(r.ymax=85);t.getScale()>=32768&&(r.ymin=-85,r.ymax=85,r.xmax=A,r.xmin=-178),function(t){const{xmin:e,ymin:r,xmax:i,ymax:n}=t;t.xmin=Math.max(-178,e),t.ymin=Math.max(-85,r),t.xmax=Math.min(A,i),t.ymax=Math.min(85,n)}(r);const i=function(t){const{xmin:e,ymin:r,xmax:i,ymax:n}=t;return{type:"Polygon",coordinates:[[[e,r],[e,n],[i,n],[i,r],[e,r]]]}}(r),n=function(t){for(let e=0;e<30;e++){const r=F[e],i=F[e+1];if(r===t)return e;if(i===t)return e+1;if(t<r&&i<t)return Math.abs(t-r)<=Math.abs(t-i)?e:e+1}}(t.pixelToDistance(1,0)),o=I.tiles(i,{min_zoom:n,max_zoom:n});this._cluster(o)}_cluster(t){if(this._isEmpty())return this;const e=this._currentTileCache,r=this._tileCache,i=this.merc,n=this.kdbush,o={},s=Math.floor(this.getMap().getZoom()),a=[],h=[];for(let h=0,u=t.length;h<u;h++){const u=t[h],[l,c,p]=u,f=[l,c,p].join("_").toString();if(o[f]=1,e[f])continue;let m;if(r[f])m=r[f];else{const t=i.bbox(l,c,p),e=n.range(t[0],t[1],t[2],t[3]);m=this._tileCluster(f,e,s)}!e[f]&&m.markers.length&&m.markers.forEach((t=>{a.push(t)})),e[f]=m}for(const t in e)o[t]||(e[t].markers.length&&e[t].markers.forEach((t=>{h.push(t)})),delete e[t]);a.length&&this.addGeometry(a),h.length&&this.removeGeometry(h)}_tileCluster(t,r,i){const n=this._tileCache,o=this.globalPoints,s=this.globalFeatures,a=this.options.maxClusterZoom;if(!n[t]&&(n[t]={points:[],features:[],coordinate:null,markers:[]},r.length)){const{x:h,y:u,points:l,features:c}=this._getClusterResult(o,r);if(n[t].coordinates=[h,u],1===r.length){const i=s[r[0]];n[t].markers=[new e.Marker(n[t].coordinates,{symbol:i.symbol,properties:i.properties||{}})]}else n[t].markers=i>a?r.map((t=>{const r=s[t];return new e.Marker(o[t],{symbol:r.symbol,properties:r.properties||{}})})):[this._getClusterMarker(n[t].coordinates,r.length,c)];this._bindMarkersEvents(n[t].markers),n[t].points=l,n[t].features=c}return n[t]}_bindMarkersEvents(t=[]){return t.forEach((t=>{const e=t.getProperties()||{};e.isCluster&&e.features&&e.features.length<=this.options.dispersionCount&&t.on("click mouseover mouseout",this._clusterDispersion,this);for(const e in this.options.markerEvents)t.on(e,this.options.markerEvents[e])})),this}_clusterDispersion(t){if(!this.options.clusterDispersion||"mouseover"===t.type)return this;const r=t.target,i=r.getCenter();if(r._children)r._children&&r._children.forEach((t=>{t.setCoordinates(i)}));else{const t=(r.getProperties()||{}).features||[];t.length&&(r._children=t.map((t=>{const r=t.geometry.coordinates;t.properties=t.properties||{},t.properties.offset=[r[0]-i.x,r[1]-i.y];const n=new e.Marker(i,{symbol:t.symbol,properties:t.properties,zIndex:1/0});return n.setZIndex(1/0),n._isDispersion=!0,n})))}const n=r._children&&r._children.length;if("click"===t.type&&n){const t=r._children.filter((t=>!t.getLayer()));t.length&&this.addGeometry(t),r._children.filter((t=>t.getLayer())).forEach((t=>{t.animate({translate:t.getProperties().offset},{duration:this.options.dispersionDuration})}))}"mouseout"===t.type&&n&&(r._children.forEach((t=>{t._animPlayer&&t.getLayer()&&t._animPlayer.finish(),t.setCoordinates(i.copy())})),this.removeGeometry(r._children.filter((t=>(t&&t._animPlayer&&t.getLayer()&&(delete t._animPlayer,delete t._animationStarted),t.getLayer())))))}_getClusterMarker(t,r,i){const n=this.options.clusterMarkerSymbol;let o;return n&&e.Util.isFunction(n)&&(o=n(r)),o||(o=function(t){const e=function(t){let e="rgb(135, 196, 240)";return t?(t>1e3&&(e="#1bbc9b"),t>5e3&&(e="rgb(216, 115, 149)"),e):e}(t);return{markerType:"ellipse",markerWidth:65,markerHeight:65,markerFill:e,markerLineWidth:1,markerFillOpacity:1,markerOpacity:1,textSize:15,textName:t,textHaloFill:"#000",textHaloRadius:1.2,textFill:"#fff"}}(r)),new e.Marker(t,{symbol:o,properties:{isCluster:!0,features:i}})}_filterGeoJSON(t){const e=[],r=[];for(let i=0,n=t.features.length;i<n;i++)"Point"===t.features[i].geometry.type&&(e.push(t.features[i].geometry.coordinates),r.push(t.features[i]));return{points:e,features:r}}_getClusterResult(t,e){const{globalFeatures:r}=this,i=[],n=[];let o=0,s=0;const a=e.length;for(let h=0;h<a;h++){const a=e[h],[u,l]=t[a];o+=u,s+=l,i.push(t[a]),n.push(r[a])}return{x:o/a,y:s/a,points:i,features:n}}}G.mergeOptions({maxClusterZoom:18,clusterMarkerSymbol:null,markerEvents:{},clusterDispersion:!1,dispersionCount:100,dispersionDuration:300}),t.TileClusterLayer=G,Object.defineProperty(t,"__esModule",{value:!0})}));
